# 🤖 Bought Finance Bot

בוט WhatsApp חכם למעקב פיננסי עם בינה מלאכותית (AI).

## ✨ תכונות

### 🤖 תכונות AI מתקדמות
- 🧠 **סיכומים חודשיים בשפה טבעית** - תובנות אישיות ומעניינות, לא רק מספרים
- 🔍 **זיהוי אנומליות אוטומטי** - הבוט מזהה הוצאות חריגות והתנהגויות יוצאות דופן
- 💡 **המלצות חיסכון מותאמות אישית** - עצות מעשיות מבוססות על ההוצאות החוזרות שלך
- 🎯 **ייעוץ פיננסי חכם** - שאל "האם אני יכול להרשות לעצמי...?" וקבל תשובה מבוססת נתונים
- 📸 **סריקת קבלות בצילום** - העלה תמונה של קבלה והבוט יחלץ אוטומטית את הסכום, העסק והפריטים

### 💰 ניהול פיננסי
- 📝 רישום אוטומטי של הוצאות והכנסות בעברית
- 🎯 **יעדי חיסכון חכמים** - הגדר יעדים, עקוב אחר התקדמות, קבל המלצות שבועיות
- 📊 סטטיסטיקות מפורטות (יומי, שבועי, חודשי)
- 💰 ניהול תקציב חודשי לפי קטגוריות
- 🚨 התראות על חריגה מתקציב (מיידיות + יומיות)
- 📅 **סיכום חודשי אוטומטי** - הבוט שולח בסוף כל חודש סיכום מפורט עם השוואה לתקציב
- ⚠️ **התראות יזומות יומיות** - הבוט בודק כל יום בשעה 18:00 ומתריע על קטגוריות שמתקרבות לגבול (85%+)

### 🔒 אבטחה
- 🛡️ אבטחה מלאה עם Helmet ו-Rate Limiting
- 🔐 תמיכה מלאה במשתמשים מרובים עם הפרדת נתונים

## 🚀 התקנה

### דרישות מקדימות

- Node.js (גרסה 16 ומעלה)
- MongoDB (מקומי או Atlas)
- חשבון OpenAI עם API Key

### שלבי התקנה

1. **שכפול הפרויקט**
```bash
git clone <repository-url>
cd bought-finance-bot
```

2. **התקנת תלויות**
```bash
npm install
```

3. **הגדרת משתני סביבה**
```bash
cp .env.example .env
```

ערוך את קובץ `.env` והוסף את הפרטים שלך:
```env
OPENAI_API_KEY=your_openai_api_key_here
MONGO_URI=mongodb+srv://username:password@cluster.mongodb.net/database_name
PORT=3001
NODE_ENV=development
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:3001
```

4. **הרצת הבוט**
```bash
# Development mode with auto-restart
npm run dev

# Production mode
npm start
```

5. **סריקת QR Code**
- פתח את WhatsApp במכשיר הנייד
- לחץ על התפריט (⋮) > WhatsApp Web
- סרוק את ה-QR Code שמופיע בטרמינל

## 📱 שימוש

### רישום הוצאות והכנסות

**באמצעות כתיבה:**
פשוט כתוב בשפה טבעית:
- "קניתי קפה ב-18 שקל"
- "תדלקתי 300 ש״ח"
- "קיבלתי משכורת 15000"

הבוט יזהה אוטומטית:
- ✅ סכום
- ✅ קטגוריה (אוכל, תחבורה, קניות, וכו')
- ✅ סוג (הוצאה/הכנסה)

**באמצעות צילום קבלה:**
פשוט שלח תמונה של הקבלה ב-WhatsApp והבוט יטפל בשאר!

הבוט יחלץ מהתמונה:
- ✅ סכום כולל
- ✅ שם העסק
- ✅ רשימת פריטים (אם זמינה)
- ✅ קטגוריה מתאימה
- ✅ תאריך (אם זמין)

### פקודות זמינות

#### 📊 סטטיסטיקות
| פקודה | תיאור |
|-------|-------|
| `כמה הוצאתי` / `מצב` | סיכום חודשי חכם עם תובנות AI |
| `היום` | סיכום יומי |
| `השבוע` | סיכום שבועי |
| `סיכום הוצאות` / `קטגוריות` | פירוט לפי קטגוריות |

#### 🎯 יעדי חיסכון
| פקודה | תיאור |
|-------|-------|
| `/יעד` | יצירת יעד חיסכון חדש |
| `היעדים` / `רשימת יעדים` | הצגת כל היעדים |
| `התקדמות` / `סטטוס יעד` | מעקב אחר יעד פעיל |

#### 💡 ייעוץ וניהול
| פקודה | תיאור |
|-------|-------|
| `האם אני יכול להרשות לעצמי...?` | ייעוץ פיננסי חכם |
| `/תקציב` | הגדרת תקציב מחדש |
| `/עזרה` | הצגת מדריך שימוש |

### קטגוריות זמינות

- 🍔 אוכל
- 🚗 תחבורה
- 🛒 קניות
- 💡 חשבונות
- 🎉 בילויים
- 💰 משכורת
- 🏥 בריאות
- 📦 כללי

### 📅 סיכום חודשי אוטומטי

הבוט שולח אוטומטית **בסוף כל חודש בשעה 20:00** סיכום מפורט לכל משתמש הכולל:

- ✅ סטטוס חיסכון או חריגה מהתקציב
- 📊 השוואה מפורטת: תקציב vs. הוצאות בפועל
- 🚨 התראות על קטגוריות שחרגו
- ⚠️ אזהרות על קטגוריות קרובות לגבול
- 💡 עצות מותאמות אישית

**דוגמה להודעה:**
```
🎊 סיכום חודשי - דצמבר 2025

🎉 כל הכבוד! חסכת 500 ₪ החודש!

📊 סיכום כללי:
💰 תקציב: 10,000 ₪
💸 הוצאת: 9,500 ₪
📈 ניצול: 95%

💡 מעולה! המשך כך גם בחודש הבא! 🚀
```

**לבדיקה ידנית של הסיכום:**
```bash
node test-monthly-report.js
```

### ⚠️ התראות תקציב יזומות

הבוט בודק **כל יום בשעה 18:00** את מצב התקציבים ושולח התראות אוטומטיות אם:

- **85%-99%** - אזהרה שהקטגוריה מתקרבת לגבול
- **100%+** - התראה על חריגה

**דוגמה להתראה:**
```
⚠️ התראת תקציב יומית

⚠️ קטגוריות קרובות לגבול (85%+):
   • אוכל: 92% - נותרו 160 ₪
   • תחבורה: 87% - נותרו 195 ₪

💡 טיפ: התחל לצמצם הוצאות בקטגוריות אלה כדי להישאר בתקציב.
```

**יתרון:** משתמשים מקבלים התראה **לפני** שהם חורגים מהתקציב, ולא רק אחרי!

**לבדיקה ידנית:**
```bash
node test-budget-alerts.js
```

### 🎯 יעדי חיסכון חכמים

הגדר יעדי חיסכון והבוט יעזור לך להגיע אליהם!

**איך זה עובד:**

1. **יצירת יעד** - כתוב `/יעד` והבוט ידריך אותך
   ```
   "אני רוצה לחסוך 5000 ש״ח לטיול ביוון עד 30.6.2026"
   ```

2. **מעקב אוטומטי** - הבוט מחשב עבורך:
   - 📊 אחוז התקדמות עם פס ויזואלי
   - 💰 כמה נותר לחסוך
   - ⏰ זמן שנשאר
   - 📈 יעד שבועי/חודשי מעודכן

3. **התראות חכמות**:
   - עדכונים על התקדמות
   - תזכורות אם אתה לא בקצב
   - כל הכבוד כשאתה מקדים את היעד!

**דוגמה להודעת התקדמות:**
```
🎯 טיול ביוון

████████░░ 80%

💰 מצב כספי:
   נצבר: 4,000 ₪
   יעד: 5,000 ₪
   נותר: 1,000 ₪

⏰ זמן נותר:
   45 ימים (6 שבועות)

📊 יעדי חיסכון:
   שבועי: 167 ₪
   חודשי: 667 ₪

🎉 אתה בקצב מעולה! צפוי היה 70% ואתה כבר ב-80%
```

### 💡 ייעוץ פיננסי אישי עם AI

שאל את הבוט שאלות על מצבך הפיננסי וקבל תשובות מבוססות נתונים!

**דוגמאות לשאלות:**
- "האם אני יכול להרשות לעצמי לקנות PS5 החודש?"
- "כדאי לי לצאת לחופשה או לחכות?"
- "האם אפשר לקנות מכונית עכשיו?"

**הבוט בודק:**
- ✅ יתרה חודשית זמינה
- ✅ הוצאות ביחס להכנסות
- ✅ יעדי חיסכון פעילים
- ✅ דפוסי הוצאות מהעבר

**דוגמה לתשובה:**
```
💡 ייעוץ פיננסי אישי

לפי המצב הנוכחי, יש לך יתרה של 3,200 ₪ החודש.
PS5 (2,500 ₪) אפשרי, אבל זה ישפיע על היעד החיסכון לטיול.
אולי כדאי לחכות חודש ולבדוק שוב?
```

### 🧠 תובנות AI חודשיות

הסיכומים החודשיים כוללים ניתוח חכם:

**תובנות בשפה טבעית:**
```
החודש היה כבד מהרגיל - עלייה של 25% בהוצאות בגלל התיקונים ברכב בקטגוריית תחבורה.
אבל כל הכבוד על הקיצוץ במסעדות! ירדת ב-30% באוכל בחוץ.
בחודש הבא, מומלץ למקד את הקיצוצים בקניות - שם יש פוטנציאל לחיסכון.
```

**זיהוי אנומליות:**
```
🔍 שימו לב:
הוצאת פי 3 מהרגיל על משלוחים החודש (1,200 ₪ לעומת ממוצע של 400 ₪).
האם זה היה מכוון או שמא יש משהו שכדאי לבדוק?
```

**המלצות חיסכון אישיות:**
```
💡 המלצה לחיסכון:
שמתי לב שאתה קונה קפה בחוץ 15 פעמים בחודש - סה"כ 450 ₪.
אם תכין קפה בבית 10 מתוך ה-15 פעמים, תחסוך כ-300 ₪ בחודש, שזה 3,600 ₪ בשנה!
```

### 📸 סריקת קבלות עם Vision AI

הבוט כולל תכונה מתקדמת לסריקת קבלות באמצעות OpenAI Vision API (GPT-4o).

**איך זה עובד:**

1. **צלם או העלה תמונת קבלה** - שלח תמונה של הקבלה ב-WhatsApp (JPG, PNG, וכו')
2. **הבוט מעבד את התמונה** - הבוט מוריד את התמונה ומנתח אותה עם AI
3. **חילוץ מידע אוטומטי** - הבוט מזהה:
   - 💰 סכום כולל (סה"כ)
   - 🏪 שם העסק
   - 📦 רשימת פריטים שנרכשו
   - 📁 קטגוריה מתאימה
   - 📅 תאריך (אם זמין)
4. **שמירה אוטומטית** - הטרנזקציה נשמרת במערכת עם כל הפרטים

**דוגמה להודעת תגובה:**
```
✅ קבלה נקלטה!

💰 סכום: 125 ₪
🏪 עסק: קפה נמרוד
📦 פריטים:
   • קפה הפוך
   • קרואסון
   • מיץ תפוזים
📁 קטגוריה: אוכל
```

**הערות חשובות:**
- הבוט תומך בקבלות בעברית ובאנגלית
- ככל שהקבלה ברורה יותר, כך התוצאה מדויקת יותר
- אם הבוט לא מזהה מידע פיננסי, הוא יודיע על כך
- הטרנזקציה מסומנת כ-`whatsapp-receipt` במערכת

**טכנולוגיה:**
- משתמש ב-**GPT-4o Vision** של OpenAI
- תומך בכל סוגי התמונות הנפוצים
- עיבוד מהיר ומדויק

## 🔌 API Endpoints

הבוט כולל API REST מלא:

### Transactions
```
GET    /api/transactions          - קבלת כל הטרנזקציות
GET    /api/transactions/:id      - קבלת טרנזקציה בודדת
POST   /api/transactions          - יצירת טרנזקציה חדשה
PUT    /api/transactions/:id      - עדכון טרנזקציה
DELETE /api/transactions/:id      - מחיקת טרנזקציה
```

### Statistics
```
GET    /api/stats/daily           - סטטיסטיקות יומיות
GET    /api/stats/weekly          - סטטיסטיקות שבועיות
GET    /api/stats/monthly         - סטטיסטיקות חודשיות
GET    /api/stats/categories      - סטטיסטיקות לפי קטגוריות
```

### Budget
```
GET    /api/budget                - קבלת תקציב
GET    /api/budget/compare        - השוואת תקציב להוצאות
```

### Health Check
```
GET    /api/health                - בדיקת תקינות השרת
```

## 🔒 אבטחה

הפרויקט כולל מספר שכבות אבטחה:

- **Helmet**: הגנה מפני פגיעויות HTTP נפוצות
- **Rate Limiting**: הגבלת בקשות (100 בקשות ל-15 דקות)
- **MongoDB Sanitization**: הגנה מפני NoSQL Injection
- **Input Validation**: בדיקת תקינות קלט
- **Body Size Limit**: הגבלה של גודל בקשות ל-10KB
- **CORS Protection**: הגבלת גישה לדומיינים מורשים

## 🏗️ מבנה הפרויקט

```
bought-finance-bot/
├── models/              # Mongoose schemas
│   ├── Transaction.js   # מודל טרנזקציות
│   └── Budget.js        # מודל תקציבים
├── services/            # Business logic
│   ├── whatsapp.js      # לוגיקת WhatsApp bot
│   └── ai.js            # אינטגרציה עם OpenAI
├── routes/              # API routes
│   └── api.js           # כל ה-endpoints
├── utils/               # Utilities
│   └── stats.js         # פונקציות סטטיסטיקה
├── server.js            # נקודת כניסה ראשית
├── .env                 # משתני סביבה (לא ב-git)
├── .env.example         # דוגמה למשתני סביבה
└── package.json         # תלויות
```

## 📊 דגשים טכניים

- **מבוסס על userId**: כל טרנזקציה מקושרת למשתמש ספציפי
- **Indexes**: אינדקסים ב-MongoDB לביצועים אופטימליים
- **Error Handling**: טיפול מקיף בשגיאות OpenAI
- **Graceful Shutdown**: כיבוי מסודר של כל השירותים
- **Multi-user Support**: תמיכה במספר משתמשים במקביל
- **Scheduled Tasks**: משימות מתוזמנות עם node-cron לסיכומים חודשיים אוטומטיים
- **Vision AI**: שימוש ב-GPT-4o Vision לסריקת קבלות ישראליות בעברית ובאנגלית

## ⚠️ אבטחת מפתחות

**חשוב מאוד:**
- אל תעלה את קובץ `.env` ל-Git
- שמור על המפתח של OpenAI בסוד
- החלף מיד מפתחות שנחשפו
- השתמש במשתני סביבה בסביבת ייצור

### 📌 הערה על פגיעויות אבטחה

הפרויקט משתמש ב-`whatsapp-web.js` שיש לה תלויות עם פגיעויות אבטחה ידועות (tar-fs, ws).
פגיעויות אלו:
- **לא משפיעות** על שימוש רגיל בבוט
- נוגעות רק לחילוץ קבצי tar ולטיפול בכותרות HTTP רבות
- הצוות של `whatsapp-web.js` עובד על עדכון התלויות

**המלצות:**
- אל תעבד קבצי tar ממקורות לא מהימנים
- השתמש ב-rate limiting (כבר מוגדר)
- עקוב אחר עדכונים של `whatsapp-web.js`

## 🐛 Troubleshooting

### הבוט לא מתחבר ל-WhatsApp
- ודא ש-WhatsApp Web לא פעיל במכשיר אחר
- מחק את התיקייה `.wwebjs_auth/` ונסה שוב

### שגיאות OpenAI
- בדוק שהמפתח תקין
- ודא שיש קרדיט בחשבון OpenAI
- בדוק את ה-rate limits

### בעיות חיבור ל-MongoDB
- ודא שה-IP שלך מורשה ב-MongoDB Atlas
- בדוק את פרטי החיבור ב-.env

## 📝 License

MIT

## 👨‍💻 תמיכה

לשאלות ובעיות, פתח Issue ב-GitHub.
