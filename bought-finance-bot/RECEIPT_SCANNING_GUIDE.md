# 📸 מדריך סריקת קבלות - Receipt Scanning Guide

## ✅ המערכת מוכנה לשימוש!

קריאת קבלות עובדת ומוכנה! הבוט משתמש ב-**GPT-4o Vision API** מבית OpenAI לזיהוי וחילוץ מידע מתמונות קבלות.

---

## 🎯 איך זה עובד?

1. **שלח תמונה של קבלה** בוואטסאפ לבוט
2. הבוט **מזהה אוטומטית** שמדובר בתמונה
3. התמונה נשלחת ל-**GPT-4o Vision** לניתוח
4. הבוט **מחלץ**:
   - סכום כולל
   - שם העסק
   - קטגוריה (אוכל, תחבורה, קניות וכו')
   - פריטים בקבלה (אם רלוונטי)
5. הנתונים **נשמרים אוטומטית** במסד הנתונים
6. הבוט **בודק** אם יש חריגה מתקציב

---

## 🔧 מה שופר?

### שיפורים שבוצעו:

1. **✨ זיהוי תמונות משופר**
   - הבוט כעת מזהה נכון תמונות בלבד (לא קבצי audio/video)
   - הוסרה הבעיה עם זיהוי 'ptt' (הודעות קוליות)

2. **📊 לוגים מפורטים**
   - לכל שלב יש לוג ברור
   - קל לאבחן בעיות אם הן קורות
   - ניתן לראות בדיוק מה ה-AI זיהה

3. **⚠️ טיפול טוב יותר בשגיאות**
   - הודעות שגיאה ברורות למשתמש
   - אבחון אוטומטי של בעיות (מכסת API, תמונה לא ברורה וכו')
   - הצעות פתרון אוטומטיות

4. **🔍 וולידציה משופרת**
   - בדיקה שהתמונה היא באמת תמונה (mimetype)
   - בדיקת תקינות של הנתונים שזוהו
   - הודעות מפורטות יותר למשתמש

---

## 🚀 איך להשתמש?

### דרך 1: שליחת תמונת קבלה בוואטסאפ

```
1. פתח שיחה עם הבוט בוואטסאפ
2. צלם קבלה או שלח תמונה מהגלריה
3. המתן לתגובה מהבוט
4. הבוט יציג את המידע שזוהה
```

### דרך 2: בדיקה ידנית מהטרמינל

```bash
# הרץ את סקריפט הבדיקה:
node test-receipt-parsing.js
```

---

## 💡 טיפים לקבלות טובות

לתוצאות מיטביות, וודא ש:

- ✅ **הקבלה ברורה וקריאה** - לא מטושטשת
- ✅ **התאורה טובה** - לא יותר מדי צל
- ✅ **הסכום הכולל נראה** - זה המידע החשוב ביותר
- ✅ **שם העסק נראה** - עוזר לזהות את הקטגוריה
- ✅ **הקבלה שטוחה** - לא מקופלת או מקומטת

---

## 🐛 פתרון בעיות

### "לא הצלחתי לזהות מידע פיננסי בקבלה"

**סיבות אפשריות:**
1. התמונה לא ברורה מספיק
2. הסכום הכולל לא נראה בקבלה
3. הקבלה בשפה שה-AI לא מזהה טוב
4. הקבלה ישנה/דהויה

**פתרונות:**
- צלם שוב עם תאורה טובה יותר
- ודא שהסכום הכולל בולט
- כתוב את ההוצאה ידנית: "קניתי [מוצר] ב-[סכום] שקל"

### "שגיאה בהורדת התמונה"

**סיבות אפשריות:**
1. בעיית חיבור אינטרנט
2. התמונה גדולה מדי
3. בעיה זמנית בוואטסאפ

**פתרונות:**
- נסה שוב
- שלח תמונה קטנה יותר (דחס אותה)
- המתן דקה ונסה שוב

### "אין מספיק קרדיט ב-OpenAI API"

**פתרון:**
1. היכנס ל-https://platform.openai.com/account/billing
2. הוסף אמצעי תשלום
3. טען קרדיט (מינימום $5)

---

## 📁 קבצים רלוונטיים

| קובץ | תיאור |
|------|--------|
| [`services/whatsapp.js`](services/whatsapp.js#L321) | פונקציית `handleReceiptImage` - מטפלת בתמונות מוואטסאפ |
| [`services/ai.js`](services/ai.js#L149) | פונקציית `parseReceipt` - מנתחת קבלות עם Vision API |
| `test-vision.js` | בדיקה בסיסית של Vision API |
| `test-receipt-parsing.js` | בדיקה מלאה של ניתוח קבלות |

---

## 🔬 בדיקות

### בדיקה 1: Vision API עובד?
```bash
node test-vision.js
```
**מה זה בודק:** שה-API Key תקין ויש גישה ל-GPT-4o Vision

### בדיקה 2: ניתוח קבלות עובד?
```bash
node test-receipt-parsing.js
```
**מה זה בודק:** שכל המערכת (Vision + פרסור + וולידציה) עובדת

---

## 📊 לוגים

כשתמונה מגיעה, תראה בטרמינל:

```
📎 הודעה עם מדיה - סוג: image
📸 התקבלה תמונת קבלה מ: 972XXXXXXXXX@c.us
⬇️ מוריד את התמונה...
✅ תמונה הורדה - גודל: 45232 bytes, mimetype: image/jpeg
🤖 שולח ל-AI לניתוח...
📸 מנתח קבלה מתמונה עם GPT-4o Vision...
📏 גודל תמונה: 60309 תווים base64
📨 תגובה מ-GPT-4o: {"amount":38,"description":"קפה ברנדה","category":"אוכל"...
📋 נתונים שפוענחו: {
  "amount": 38,
  "description": "קפה ברנדה",
  "category": "אוכל",
  "type": "expense"
}
✅ זוהה מקבלה: קפה ברנדה - 38₪
✅ AI זיהה: קפה ברנדה - 38₪
💾 נשמר מקבלה: קפה ברנדה - 38₪
```

---

## 🎨 דוגמת שימוש

**משתמש שולח תמונת קבלה →**

**בוט משיב:**
```
📸 מעבד את הקבלה... רגע אחד ⏳

✅ קלטתי את הקבלה!

💸 קפה ברנדה
📁 אוכל
💵 38₪
🏪 קפה ברנדה

📝 פריטים:
  • קפה הפוך
  • עוגייה
  • מים
```

---

## 🆘 עזרה נוספת

אם יש בעיות:

1. **בדוק את הלוגים בטרמינל** - הם יראו איפה הבעיה
2. **הרץ את הטסטים** - `test-vision.js` ו-`test-receipt-parsing.js`
3. **ודא שה-API Key תקין** - בדוק ב-`.env`
4. **בדוק שיש קרדיט** - https://platform.openai.com/account/usage

---

## 📝 הערות טכניות

- **מודל**: GPT-4o (עם Vision)
- **פורמט תמונות**: JPG, PNG, WEBP
- **גודל מקסימלי**: תלוי ב-WhatsApp (בדרך כלל עד 16MB)
- **זמן עיבוד**: 2-5 שניות בממוצע
- **עלות**: ~$0.01-0.03 לכל תמונה (תלוי בגודל)

---

## ✨ סיכום

המערכת **עובדת ומוכנה לשימוש**!

✅ Vision API פעיל
✅ קוד משופר עם לוגים
✅ טיפול שגיאות משופר
✅ וולידציות מחוזקות

**פשוט שלח תמונת קבלה לבוט בוואטסאפ והוא יעבד אותה אוטומטית!** 🎉
